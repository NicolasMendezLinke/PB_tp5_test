name: CI-CD Pipeline

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:

  build:
    name: Build Maven Project
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Log de início do build
        run: echo "Iniciando etapa de build do projeto"

      - name: Build Maven
        run: mvn -B -DskipTests clean package

      - name: Log de conclusão
        run: echo "Build finalizado com sucesso"

  unit_tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Executar testes unitários
        run: mvn test -Dtest=*UnitTest

      - name: Log final
        run: echo "Testes unitários executados com sucesso"

  deploy:
    name: Deploy da aplicação
    runs-on: ubuntu-latest
    needs: [ unit_tests ]

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build para produção
        run: mvn -DskipTests clean package

      - name: Iniciar servidor em background
        run: |
          nohup java -jar target/*.jar > server.log 2>&1 &
          echo "Servidor iniciado em background"
          sleep 8

      - name: Upload de log para debugging
        uses: actions/upload-artifact@v4
        with:
          name: deploy-log
          path: server.log

  post_deploy_tests:
    name: Post-Deploy HTTP Tests
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Verificar se o servidor está respondendo
        run: |
          echo "Testando endpoint principal..."
          for i in {1..10}; do
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:7000/funcionarios)
            if [ "$STATUS" -eq 200 ]; then
              echo "Servidor respondeu com 200 OK"
              break
            fi
            echo "Aguardando servidor subir..."
            sleep 2
          done
          if [ "$STATUS" -ne 200 ]; then
            echo "Falha: servidor não respondeu com 200"
            exit 1
          fi

      - name: Testar conteúdo da página
        run: |
          CONTENT=$(curl -s http://localhost:7000/funcionarios)
          if [[ "$CONTENT" == *"funcionarios"* ]] || [[ "$CONTENT" == *"Funcionários"* ]]; then
            echo "Página contém conteúdo esperado"
          else
            echo "Erro: Conteúdo inesperado no HTML"
            exit 1
          fi

      - name: Log final
        run: echo "Testes pós-deploy concluídos com sucesso"
